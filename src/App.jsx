import React, { useState, useEffect } from 'react';
import { Home, PenLine, BarChart3, Settings, CalendarDays } from 'lucide-react';
import Dashboard from './components/Dashboard';
import Logs from './components/Logs';
import Charts from './components/Charts';
import Profile from './components/Profile';
import CalendarView from './components/CalendarView';
import Onboarding from './components/Onboarding';
import LandingPage from './components/LandingPage';

import { AuthProvider, useAuth } from './contexts/AuthContext';
import Login from './components/Login';

import { userService } from './services/userService';

const NavItem = ({ icon: Icon, active, onClick }) => (
    <button
        onClick={onClick}
        className={`p-3 transition-all duration-300 ${active
            ? 'text-brand'
            : 'text-slate-400 hover:text-brand'
            }`}
    >
        <Icon size={26} strokeWidth={active ? 2.5 : 2} />
    </button>
);



const MainApp = ({ guestUser, setGuestUser }) => {
    const { currentUser, userData, logout } = useAuth();
    const [activeTab, setActiveTab] = useState('home');
    const [isMigrating, setIsMigrating] = useState(false);

    // Migration Bridge: LocalStorage -> Firestore
    useEffect(() => {
        const performMigration = async () => {
            if (currentUser && !userData && !isMigrating) {
                setIsMigrating(true);

                // Prioritize guest storage, then user-specific, then legacy
                const guestData = localStorage.getItem('mounjoy_guest_user');
                const userSpecificData = localStorage.getItem(`mounjoy_user_${currentUser.uid}`);
                const legacyData = localStorage.getItem('mounjoy_user2');
                const dataToMigrate = guestData || userSpecificData || legacyData;

                if (dataToMigrate) {
                    try {
                        const parsed = JSON.parse(dataToMigrate);
                        console.log("Migrating local data to Cloud Firestore...");

                        await userService.saveUserProfile(currentUser.uid, {
                            ...parsed,
                            uid: currentUser.uid,
                            email: currentUser.email || parsed.email || '',
                            photoURL: currentUser.photoURL || parsed.photoURL || ''
                        });

                        // Clean up
                        if (guestData) {
                            localStorage.removeItem('mounjoy_guest_user');
                            setGuestUser(null);
                        }
                        if (legacyData) localStorage.removeItem('mounjoy_user2');
                    } catch (e) {
                        console.error("Migration failed:", e);
                    }
                }
                setIsMigrating(false);
            }
        };

        performMigration();
    }, [currentUser, userData, isMigrating, setGuestUser]);

    const handleUpdateUser = async (newData) => {
        const currentUserData = userData || guestUser;
        const updatedData = typeof newData === 'function' ? newData(currentUserData) : newData;

        if (currentUser) {
            await userService.saveUserProfile(currentUser.uid, updatedData);
        } else {
            setGuestUser(updatedData);
            localStorage.setItem('mounjoy_guest_user', JSON.stringify(updatedData));
        }
    };

    const handleReset = async () => {
        if (currentUser) {
            await logout();
        } else {
            localStorage.removeItem('mounjoy_guest_user');
            setGuestUser(null);
        }
    };

    // Unified user object
    const user = userData || guestUser;

    if (!user) return null; // Should not happen with current routing

    const renderContent = () => {
        switch (activeTab) {
            case 'home': return <Dashboard user={user} setUser={handleUpdateUser} setActiveTab={setActiveTab} />;
            case 'logs': return <Logs user={user} setUser={handleUpdateUser} />;
            case 'calendar': return <CalendarView user={user} setUser={handleUpdateUser} />;
            case 'charts': return <Charts user={user} />;
            case 'profile': return <Profile user={user} onReset={handleReset} setUser={handleUpdateUser} />;
            default: return <Dashboard user={user} setUser={handleUpdateUser} setActiveTab={setActiveTab} />;
        }
    };

    const getWeekNumber = () => {
        const start = new Date(user.startDate);
        const now = new Date();
        const diffTime = Math.abs(now - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
        return Math.ceil(diffDays / 7);
    };

    const medicationName = user.medicationId ? (user.medicationId.charAt(0).toUpperCase() + user.medicationId.slice(1)) : 'Protocolo';

    return (
        <div className="min-h-screen bg-transparent pb-24 selection:bg-brand-100">
            <header className="px-6 py-6 flex justify-between items-center bg-transparent max-w-md mx-auto">
                <div>
                    <h1 className="text-2xl font-bold text-brand-900 tracking-tight">Olá, {user.name}</h1>
                    <p className="text-sm text-slate-500 font-semibold font-outfit">
                        Você está na {getWeekNumber()}ª semana em uso de {medicationName}
                    </p>
                </div>
                <div className="flex items-center gap-2">


                    <div
                        className="w-12 h-12 bg-white rounded-2xl shadow-soft flex items-center justify-center border border-slate-100 cursor-pointer hover:shadow-lg transition-all overflow-hidden"
                        onClick={() => setActiveTab('profile')}
                    >
                        {user.photoURL ? (
                            <img src={user.photoURL} alt={user.name} className="w-full h-full object-cover" />
                        ) : (
                            <span className="text-brand-600 font-bold text-lg">{user.name?.charAt(0).toUpperCase() || '?'}</span>
                        )}
                    </div>
                </div>
            </header>

            <main className="px-6 max-w-md mx-auto">
                {renderContent()}
            </main>

            <nav className="fixed bottom-6 left-5 right-5 h-16 bg-white/90 backdrop-blur-md rounded-full shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white/50 flex justify-around items-center px-2 z-40 max-w-sm mx-auto">
                <NavItem icon={Home} active={activeTab === 'home'} onClick={() => setActiveTab('home')} />
                <NavItem icon={PenLine} active={activeTab === 'logs'} onClick={() => setActiveTab('logs')} />
                <NavItem icon={CalendarDays} active={activeTab === 'calendar'} onClick={() => setActiveTab('calendar')} />
                <NavItem icon={BarChart3} active={activeTab === 'charts'} onClick={() => setActiveTab('charts')} />
                <NavItem icon={Settings} active={activeTab === 'profile'} onClick={() => setActiveTab('profile')} />
            </nav>
        </div>
    );
};

const AppContent = () => {
    const { currentUser, userData } = useAuth();
    const [startedOnboarding, setStartedOnboarding] = useState(false);
    const [showLogin, setShowLogin] = useState(false);
    const [guestUser, setGuestUser] = useState(() => {
        const saved = localStorage.getItem('mounjoy_guest_user');
        return saved ? JSON.parse(saved) : null;
    });

    const handleOnboardingComplete = (data) => {
        const now = new Date().toISOString();
        const newUser = {
            ...data,
            currentWeight: parseFloat(data.startWeight),
            history: [parseFloat(data.startWeight)],
            startDate: now,
            lastWeightDate: now,
            doseHistory: [{
                date: now,
                dose: data.currentDose,
                medication: data.medicationId,
                site: 'Não registrado'
            }],
            sideEffectsLogs: [],
            measurements: [],
            thoughtLogs: [],
            dailyIntakeHistory: {},
            isMaintenance: false,
            settings: {
                remindersEnabled: true,
                proteinGoal: 100,
                waterGoal: 2.5,
                reminderTime: '09:00'
            }
        };

        if (currentUser) {
            userService.saveUserProfile(currentUser.uid, {
                ...newUser,
                uid: currentUser.uid,
                email: currentUser.email,
                photoURL: currentUser.photoURL || ''
            });
        } else {
            setGuestUser(newUser);
            localStorage.setItem('mounjoy_guest_user', JSON.stringify(newUser));
        }
        setStartedOnboarding(false);
    };

    // Priority: 1. Cloud User Data, 2. Guest User Data
    const hasAnyUser = userData || guestUser;

    // If we have a user (logged in or guest), we show the main app
    // HOWEVER: If a user IS logged in but Firestore hasn't loaded yet (userData is null),
    // and they DON'T have guest data, we might show a loading state or the MainApp will handle it.
    // Given AuthProvider handles loading, if currentUser exists, userData will eventually follow.
    if (currentUser || guestUser) {
        return <MainApp guestUser={guestUser} setGuestUser={setGuestUser} />;
    }

    // If user clicked "Entrar", show the login screen
    if (showLogin) {
        return <Login onBack={() => setShowLogin(false)} />;
    }

    // If user clicked "Começar" on landing, show onboarding
    if (startedOnboarding) {
        return <Onboarding onComplete={handleOnboardingComplete} />;
    }

    // Default: Show the Landing Page
    return (
        <LandingPage
            onStart={() => setStartedOnboarding(true)}
            onLogin={() => setShowLogin(true)}
        />
    );
};

const App = () => {
    return (
        <AuthProvider>
            <AppContent />
        </AuthProvider>
    );
};

export default App;
